name: e2e

on:
    pull_request:
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    e2e:
        runs-on: ubuntu-latest
        timeout-minutes: 90
        permissions:
            contents: read

        steps:
            - uses: actions/checkout@v4

            - uses: pnpm/action-setup@v4

            - uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: 'pnpm'
                  cache-dependency-path: 'pnpm-lock.yaml'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Install Playwright browser
              run: pnpm exec playwright install --with-deps chromium

            - name: Print runtime versions
              run: |
                  set -euo pipefail
                  node --version
                  pnpm --version
                  pnpm exec playwright --version
                  docker --version
                  docker compose version

            - name: Start CHAP + DHIS2 stack
              run: pnpm docker:e2e up

            - name: Show docker service status
              run: |
                  set -euo pipefail
                  docker ps --all
                  docker compose --project-name chap-platform --env-file docker/.env.example -f docker/compose.chap.yml -f docker/compose.dhis2.yml ps

            - name: Wait for CHAP + DHIS2 + route
              run: |
                  set -euo pipefail

                  wait_url() {
                    local name="$1"
                    local url="$2"
                    local max_seconds="${3:-900}"
                    local waited=0

                    until curl --silent --fail "$url" >/dev/null; do
                      if [ "$waited" -ge "$max_seconds" ]; then
                        echo "Timed out waiting for $name at $url"
                        return 1
                      fi
                      sleep 5
                      waited=$((waited + 5))
                    done

                    echo "$name is ready ($url)"
                  }

                  wait_url "CHAP health" "http://localhost:8000/health"
                  wait_url "DHIS2 login page" "http://localhost:8080/dhis-web-login"

                  route_query_url='http://localhost:8080/api/routes?filter=code:eq:chap&fields=id,code,url&paging=false'
                  route_wait_seconds=1800
                  waited=0
                  while true; do
                    route_response=$(curl --silent --show-error --user 'system:S&stem123!' "$route_query_url" || true)
                    route_count=$(echo "$route_response" | jq -r '.routes | length' 2>/dev/null || echo 0)
                    route_url=$(echo "$route_response" | jq -r '.routes[0].url // empty' 2>/dev/null || echo '')

                    if [ "$route_count" -ge 1 ] && [ -n "$route_url" ] && [ "$route_url" != "null" ]; then
                      echo "DHIS2 route 'chap' is ready (url=$route_url)"
                      echo "Route details:"
                      echo "$route_response" | jq -r '.routes[] | "id=\(.id) code=\(.code) url=\(.url)"' || true
                      break
                    fi

                    analytics_state="$(docker inspect --format '{{.State.Status}} {{.State.ExitCode}}' chap-platform-dhis2-analytics-1 2>/dev/null || true)"
                    if [[ "$analytics_state" =~ ^exited\ [1-9][0-9]*$ ]]; then
                      echo "dhis2-analytics failed (state: $analytics_state)"
                      docker compose --project-name chap-platform --env-file docker/.env.example -f docker/compose.chap.yml -f docker/compose.dhis2.yml logs --no-color dhis2-analytics
                      exit 1
                    fi

                    if [ "$waited" -ge "$route_wait_seconds" ]; then
                      echo "Timed out waiting for DHIS2 route 'chap' (last response: $route_response)"
                      exit 1
                    fi
                    sleep 5
                    waited=$((waited + 5))
                  done

            - name: Run e2e tests
              env:
                  # Keep hosts consistent for cookie + localStorage origins.
                  # The Playwright `storageState` includes DHIS2 session cookies scoped to the host used during login.
                  E2E_APP_URL: http://localhost:3000
                  E2E_DHIS2_BASE_URL: http://localhost:8080
              run: pnpm e2e:ci

            - name: Upload Playwright report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-report
                  path: playwright-report/
                  if-no-files-found: error
                  retention-days: 7

            - name: Upload Playwright test results (traces/videos)
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-test-results
                  path: test-results/
                  if-no-files-found: ignore
                  retention-days: 7

            - name: Dump stack logs on failure
              if: failure()
              run: |
                  set -euo pipefail
                  echo "==== docker ps ===="
                  docker ps --all || true
                  echo "==== CHAP + DHIS2 logs (tail) ===="
                  pnpm docker:e2e logs || true